<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/remodal/1.1.0/remodal.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.7/download.min.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/api.js?onload=loadPicker"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/filesize/3.5.10/filesize.min.js"></script>

<script>
//DataTable Initialisation
$(document).ready(function(){
    $('#files-table').DataTable();
});

google.script.run.withSuccessHandler(updateFiles).getDatabase();

function updateFiles(udsDatabase){
  var table = $('#files-table').DataTable();
  table.clear();
  for (var i = 1; i < udsDatabase.length; i++){
    //this should work as long as no one screws with the ordering. Use this if things go wrong: https://datatables.net/reference/type/row-selector
    var downloadButtonCode = '<a class="button button-download" data-file-id="' + udsDatabase[i][1] + '" data-content-type="' + udsDatabase[i][2] + '" data-file-name="' + udsDatabase[i][0] + '" data-parts="' + udsDatabase[i][3] + '" data-row-id="' + i + '"><i class="fa fa-cloud"></i> Download</a> '
    table.row.add ([udsDatabase[i][0], udsDatabase[i][4],udsDatabase[i][2],downloadButtonCode]);
  }
  table.draw();
  
  $(".button-download").click(function() {
    var fileID = $(this).data("file-id");
    var filename = $(this).data("file-name");
    var contentType = $(this).data("content-type");
    var parts = $(this).data("parts");
    openToast("download");
    google.script.run.withSuccessHandler(reassembleSuccess).withUserObject(filename, contentType).reassemble(fileID, parts);
  });
  
  //Make sure everythings the right colour

}


// UPLOAD

 var file, 
      reader = new FileReader();

  // Upload the file to Google Drive
  reader.onloadend = function(e) {
   var fsize = $("#file")[0].files[0].size;
   
   google.script.run
      .withSuccessHandler(uploadSuccess)
      .upload(
         e.target.result, file.name, fize
      );
  };

  // Read the file on form submit
  function submitForm() {
    var filesPicked = $('#file')[0].files;
    //Make sure that something is indeed selected
    if (filesPicked.length != 0){
       $("#uploadButton").hide();
       $(".spinner").css("display", "inline-block");
       file = filesPicked[0];
       
       reader.readAsDataURL(file);
    }
    else
    {
       alert("You haven't selected anything");
    }
  }
  
  function uploadSuccess() {
   alert("success");
   $(".spinner").css("display", "none");
   $("#uploadButton").show();
   google.script.run.withSuccessHandler(updateFiles).getDatabase();
  }
  


  
  function reassembleSuccess(input, filename, contentType) {
   download(input, filename, contentType);
   setTimeout(function(){
        closeToast("download");
    },1001);
  }
  
$(".button").click(function(){

    var toastid = $(this).attr('data-toast');

    if (typeof toastid !== typeof undefined && toastid !== false) {
        if ($(".toast").hasClass("toast-open")) {
            toast(toastid);
        }
        else {
            toast(toastid);
        }
    }
});

function openToast(toastid) {
    var numOpenToasts = $('div.toast-open').length + $('div.toast-opening').length;
    var toastduration = 3000;
    var toastanimationlength = 1000 - 1;
    var toastid = "#" + toastid;
    var baseHeight = 20;

    //var toastheight = (baseHeight * (numOpenToasts + 1) + 100) + "px";

    /*if numOpenToasts > 0 {
                    $('.toast-open').addClass('toast-closing');
                }*/

    $(toastid).removeClass("toast-closing");
    $(toastid).addClass("toast-opening");
    setTimeout(function(){
        $(toastid)./*css("bottom",toastheight)*/addClass("toast-open").removeClass("toast-opening");
        /*setTimeout(function(){
            $(toastid).removeClass("toast-open").addClass("toast-closing");         
        },toastduration);    */        
    },toastanimationlength);
}

function closeToast(toastid) {
    $("#" + toastid).removeClass("toast-open toast-opening").addClass("toast-closing");  
}

function importSuccess() {
 setTimeout(function(){
        closeToast("import");
    },1001);

 google.script.run.withSuccessHandler(updateFiles).getDatabase();
}



</script>